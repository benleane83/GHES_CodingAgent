trigger: none

pool:
  vmImage: ubuntu-latest

resources:
  webhooks:
    - webhook: myWebhookResource
      connection: GHCopilotWH

variables:
  - group: 'GitHub Copilot CLI'
  # No puedes definir env variables aquÃ­, pero puedes usarlas con $(variable)
  # Las variables del Variable Group estÃ¡n disponibles como $(GH_TOKEN) y $(AZURE_DEVOPS_EXT_PAT)

steps:
  - script: echo "ğŸš€ Webhook triggered pipeline started!"
    displayName: ğŸš€ Start Pipeline

  - task: NodeTool@0
    inputs:
      versionSource: 'spec'
      versionSpec: '22.x'
      checkLatest: true
    displayName: âš™ï¸ Setup Node.js 22.x

  - bash: |
      # Access webhook data as parameter
      echo "ğŸ”” Processing webhook payload..."
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo "ğŸ“‹ WEBHOOK INFORMATION"
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo ""
      echo "ğŸ”– Event Type: ${{ parameters.myWebhookResource.eventType }}"
      echo "ğŸ†” Subscription ID: ${{ parameters.myWebhookResource.subscriptionId }}"
      echo "ğŸ”‘ Notification ID: ${{ parameters.myWebhookResource.notificationId }}"
      echo "ğŸ¯ Event ID: ${{ parameters.myWebhookResource.id }}"
      echo "ğŸ“¡ Publisher ID: ${{ parameters.myWebhookResource.publisherId }}"
      echo "ğŸ“… Created Date: ${{ parameters.myWebhookResource.createdDate }}"
      echo "ğŸ”¢ Resource Version: ${{ parameters.myWebhookResource.resourceVersion }}"
      echo ""
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo "ğŸ’¬ MESSAGE"
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo ""
      echo "${{ parameters.myWebhookResource.message.text }}"
      echo ""
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo "ğŸ“ WORK ITEM DETAILS (from webhook)"
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo ""
      echo "ğŸ†” Work Item ID: ${{ parameters.myWebhookResource.resource.id }}"
      echo "ğŸ”„ Revision: ${{ parameters.myWebhookResource.resource.rev }}"
      echo "ğŸ“Œ Title: ${{ parameters.myWebhookResource.resource.fields['System.Title'] }}"
      echo "ğŸ·ï¸  Type: ${{ parameters.myWebhookResource.resource.fields['System.WorkItemType'] }}"
      echo "ğŸ“Š State: ${{ parameters.myWebhookResource.resource.fields['System.State'] }}"
      echo "â“ Reason: ${{ parameters.myWebhookResource.resource.fields['System.Reason'] }}"
      echo "ğŸ¯ Priority: ${{ parameters.myWebhookResource.resource.fields['Microsoft.VSTS.Common.Priority'] }}"
      echo ""
      echo "ğŸ“„ Description:"
      echo "${{ parameters.myWebhookResource.resource.fields['System.Description'] }}"
      echo ""
      echo "ğŸ‘¤ Created By: ${{ parameters.myWebhookResource.resource.fields['System.CreatedBy'] }}"
      echo "ğŸ“… Created Date: ${{ parameters.myWebhookResource.resource.fields['System.CreatedDate'] }}"
      echo ""
      echo "ğŸ‘¥ Assigned To: ${{ parameters.myWebhookResource.resource.fields['System.AssignedTo'] }}"
      echo ""
      echo "ğŸ”„ Changed By: ${{ parameters.myWebhookResource.resource.fields['System.ChangedBy'] }}"
      echo "ğŸ“… Changed Date: ${{ parameters.myWebhookResource.resource.fields['System.ChangedDate'] }}"
      echo ""
      echo "ğŸ“‚ Area Path: ${{ parameters.myWebhookResource.resource.fields['System.AreaPath'] }}"
      echo "ğŸ” Iteration Path: ${{ parameters.myWebhookResource.resource.fields['System.IterationPath'] }}"
      echo "ğŸ“ Team Project: ${{ parameters.myWebhookResource.resource.fields['System.TeamProject'] }}"
      echo ""
      echo "âš ï¸  Severity: ${{ parameters.myWebhookResource.resource.fields['Microsoft.VSTS.Common.Severity'] }}"
      echo "ğŸ“‹ Kanban Column: ${{ parameters.myWebhookResource.resource.fields['WEF_EB329F44FE5F4A94ACB1DA153FDF38BA_Kanban.Column'] }}"
      echo ""
      echo "ğŸ”— Work Item URL: ${{ parameters.myWebhookResource.resource.url }}"
      echo ""
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      # Set pipeline variables for later use
      echo "##vso[task.setvariable variable=WorkItemId]${{ parameters.myWebhookResource.resource.id }}"
      echo "##vso[task.setvariable variable=WorkItemTitle]${{ parameters.myWebhookResource.resource.fields['System.Title'] }}"
      echo "##vso[task.setvariable variable=WorkItemType]${{ parameters.myWebhookResource.resource.fields['System.WorkItemType'] }}"
      echo "##vso[task.setvariable variable=WorkItemState]${{ parameters.myWebhookResource.resource.fields['System.State'] }}"
      echo "##vso[task.setvariable variable=WorkItemCreatedBy]${{ parameters.myWebhookResource.resource.fields['System.CreatedBy'] }}"
      echo "##vso[task.setvariable variable=WorkItemAssignedTo]${{ parameters.myWebhookResource.resource.fields['System.AssignedTo'] }}"
      echo "##vso[task.setvariable variable=WorkItemDescription]${{ parameters.myWebhookResource.resource.fields['System.Description'] }}"
      echo "##vso[task.setvariable variable=ProjectName]${{ parameters.myWebhookResource.resource.fields['System.TeamProject'] }}"
    displayName: ğŸ“‹ Parse Webhook Data

  - bash: |
      npm install -g @github/copilot     
    displayName: ğŸ“¦ Install Copilot CLI

  - bash: |
      echo "ğŸ” Verificando variables de entorno..."
      echo ""
      
      if [ -z "$GH_TOKEN" ]; then
        echo "âŒ ERROR: GH_TOKEN no estÃ¡ definido o estÃ¡ vacÃ­o"
        exit 1
      else
        echo "âœ… GH_TOKEN estÃ¡ definido (longitud: ${#GH_TOKEN} caracteres)"
      fi
      
      if [ -z "$AZURE_DEVOPS_PAT" ]; then
        echo "âŒ ERROR: AZURE_DEVOPS_PAT no estÃ¡ definido o estÃ¡ vacÃ­o"
        exit 1
      else
        echo "âœ… AZURE_DEVOPS_PAT estÃ¡ definido (longitud: ${#AZURE_DEVOPS_PAT} caracteres)"
      fi
      
      echo ""
      echo "âœ… Todas las variables necesarias estÃ¡n configuradas correctamente"
    displayName: âœ… Verify Credentials
    env:
      GH_TOKEN: $(GH_TOKEN)
      AZURE_DEVOPS_PAT: $(AZURE_DEVOPS_EXT_PAT)

  # - bash: |
  #     echo "ğŸ¤– Running GitHub Copilot CLI to test that it works"     
  #     copilot -p "Puedes decirme de quÃ© trata este proyecto" --allow-all-tools
  #   displayName: ğŸ¤– Verify GitHub Copilot CLI Installation
  #   env:
  #     GH_TOKEN: $(GH_TOKEN)
  # - bash: |
  #     cp mcp-config.json ~/.copilot/mcp-config.json
  #   displayName: Copiar el archivo de los MCP servers en ~/.copilot

  # - bash: |
  #     echo "ğŸ¤– Running GitHub Copilot CLI to get work item details"
  #     copilot \
  #     -p "Get the details of work item ID $(WorkItemId) from Azure DevOps project '$(ProjectName)'. Show me all the information including title, description, assigned to, state, and any other relevant fields." \
  #     --allow-all-tools \
  #     --log-level debug \
  #     --log-dir ./logs
  #   displayName: ğŸ¤– Get Work Item details via Copilot CLI
  #   env:
  #     GH_TOKEN: $(GH_TOKEN)
  #     AZURE_DEVOPS_EXT_PAT: $(AZURE_DEVOPS_EXT_PAT)

  - bash: |
      echo "ğŸ¤– Running GitHub Copilot CLI to implement changes"
      copilot \
      -p "Quiero implementar los cambios necesarios en el work item $(WorkItemId) de Azure DevOps project '$(ProjectName)'" \
      --allow-all-tools \
      --log-level debug \
      --log-dir ./logs
    displayName: ğŸš€ Implement Changes
    env:
      GH_TOKEN: $(GH_TOKEN)
      AZURE_DEVOPS_PAT: $(AZURE_DEVOPS_EXT_PAT)

  - task: PublishPipelineArtifact@1
    inputs:
      targetPath: 'logs'
      artifact: 'copilot-logs'
    displayName: ï¿½ Publish Logs
