# üöÄ Deploying Copilot Workflows to New Repositories

This guide explains how to deploy the GitHub Copilot Coder and Reviewer workflows to any repository on your GitHub Enterprise Server.

## üìã Prerequisites Summary

Before deploying, ensure these prerequisites are met:

### Self-Hosted Runner Requirements

| Component | Required | Installation |
|-----------|----------|--------------|
| **GitHub CLI (`gh`)** | ‚úÖ Yes | Must be pre-installed manually |
| **Node.js 22.x** | ‚úÖ Yes | Installed automatically by workflow |
| **Python 3.x** | ‚úÖ Yes | Installed automatically by workflow |
| **uv/uvx** | ‚úÖ Yes | Installed automatically by workflow |

### Repository Secrets

| Secret | Required | Description |
|--------|----------|-------------|
| `GH_TOKEN` | ‚úÖ Yes | **Classic PAT** from GHES with `repo` and `workflow` scopes |
| `COPILOT_TOKEN` | ‚úÖ Yes | Token for GitHub Copilot API access |
| `CONTEXT7_API_KEY` | ‚ùå Optional | API key for Context7 documentation service |

### Required Labels

| Label | Color | Purpose |
|-------|-------|---------|
| `copilot` | `#7057ff` | Triggers code generation workflow |
| `in-progress` | `#fbca04` | Applied while workflow is running |
| `ready-for-review` | `#0e8a16` | Applied when PR is ready |
| `copilot-generated` | `#1d76db` | Applied to generated PRs |

---

## üîß Option 1: Automated Deployment (Recommended)

Use the deployment script to automatically set up everything:

```bash
# From the GHES_CodingAgent repository
./scripts/deploy-to-repo.sh <ghes-host> <owner> <repo> <gh-token>
```

### Example

```bash
./scripts/deploy-to-repo.sh vm-ghes.company.com myorg my-new-repo ghp_xxxxxxxxxxxx
```

### What the Script Does

1. ‚úÖ Clones the target repository
2. ‚úÖ Copies all workflow files
3. ‚úÖ Copies required scripts
4. ‚úÖ Copies MCP configuration
5. ‚úÖ Creates required labels
6. ‚úÖ Updates GHES hostname in workflows
7. ‚úÖ Creates a Pull Request with setup instructions

### After Running the Script

1. **Review and merge** the created PR
2. **Add repository secrets** (see below)
3. **Verify runner setup** (GitHub CLI installed)

---

## üîß Option 2: Manual Deployment

If you prefer manual setup or the script doesn't work in your environment:

### Step 1: Copy Files

Copy these files/folders to your target repository:

```
.github/
‚îú‚îÄ‚îÄ workflows/
‚îÇ   ‚îú‚îÄ‚îÄ copilot-coder.yml
‚îÇ   ‚îî‚îÄ‚îÄ copilot-reviewer.yml
‚îî‚îÄ‚îÄ copilot-instructions.md

scripts/
‚îú‚îÄ‚îÄ prepare-commit.sh
‚îú‚îÄ‚îÄ push-branch.sh
‚îú‚îÄ‚îÄ post-workflow-comment.sh
‚îú‚îÄ‚îÄ get-pr-diff.sh
‚îú‚îÄ‚îÄ download-pr-files.sh
‚îú‚îÄ‚îÄ analyze-with-copilot.sh
‚îî‚îÄ‚îÄ post-pr-comment.sh

mcp-config.json
```

### Step 2: Update GHES Hostname

In `.github/workflows/copilot-coder.yml`, replace the GHES hostname:

```yaml
# Find and replace:
vm-ghes.uaenorth.cloudapp.azure.com
# With your GHES hostname:
your-ghes-instance.company.com
```

### Step 3: Make Scripts Executable

```bash
chmod +x scripts/*.sh
```

### Step 4: Create Labels

Using GitHub CLI:

```bash
gh label create "copilot" --color "7057ff" --description "Trigger Copilot code generation"
gh label create "in-progress" --color "fbca04" --description "Copilot is working on this issue"
gh label create "ready-for-review" --color "0e8a16" --description "Ready for code review"
gh label create "copilot-generated" --color "1d76db" --description "Code generated by Copilot"
```

### Step 5: Configure Secrets

Go to **Settings ‚Üí Secrets and variables ‚Üí Actions** and add:

1. **`GH_TOKEN`** - Classic PAT with `repo` and `workflow` scopes
2. **`COPILOT_TOKEN`** - Copilot API token
3. **`CONTEXT7_API_KEY`** - (Optional) Context7 API key

---

## üîê Creating the GH_TOKEN

The `GH_TOKEN` **must be a Classic PAT** created on your GHES instance (not github.com).

### Steps

1. Go to `https://<your-ghes-host>/settings/tokens`
2. Click **"Generate new token"** ‚Üí **"Generate new token (classic)"**
3. Set expiration (recommend 90 days or longer)
4. Select scopes:
   - ‚úÖ `repo` (Full control of private repositories)
   - ‚úÖ `workflow` (Update GitHub Action workflows)
5. Click **Generate token**
6. Copy and save the token securely

### ‚ö†Ô∏è Important Notes

- **Do NOT use Fine-grained PATs** - They have issues with GraphQL operations on GHES
- **Create on GHES, not github.com** - The token must be from your GHES instance
- **Rotate regularly** - Set calendar reminders for token expiration

---

## üñ•Ô∏è Self-Hosted Runner Setup

### Install GitHub CLI (Required)

SSH into your runner VM and run:

```bash
# Download GitHub CLI
GH_VERSION="2.62.0"
cd /tmp
curl -L -o gh.tar.gz "https://github.com/cli/cli/releases/download/v${GH_VERSION}/gh_${GH_VERSION}_linux_amd64.tar.gz"

# Extract and install
tar -xzf gh.tar.gz
sudo mv gh_${GH_VERSION}_linux_amd64/bin/gh /usr/local/bin/
sudo chmod +x /usr/local/bin/gh

# Verify
gh --version
```

### If Runner Cannot Reach github.com

Download the binary on another machine and transfer:

```powershell
# On a machine with internet access
curl -L -o gh.tar.gz "https://github.com/cli/cli/releases/download/v2.62.0/gh_2.62.0_linux_amd64.tar.gz"

# Transfer to runner
scp gh.tar.gz user@<runner-ip>:/tmp/
```

Then install on the runner as shown above.

---

## ‚úÖ Verification Checklist

After deployment, verify everything is set up correctly:

- [ ] Workflows visible in **Actions** tab
- [ ] All 4 labels created
- [ ] `GH_TOKEN` secret configured
- [ ] `COPILOT_TOKEN` secret configured
- [ ] Scripts are executable (`ls -la scripts/`)
- [ ] GitHub CLI installed on runner (`gh --version`)
- [ ] Runner is online and idle

### Test the Setup

1. Create a test issue with a simple task description
2. Add the `copilot` label
3. Watch the workflow run in the Actions tab
4. Verify PR is created successfully

---

## üîÑ Updating Deployed Workflows

To update workflows in repositories where they're already deployed:

1. Update files in this source repository
2. Re-run the deployment script, OR
3. Manually copy updated files to target repos

---

## üÜò Troubleshooting

### Common Issues

| Issue | Solution |
|-------|----------|
| `gh: command not found` | Install GitHub CLI on runner |
| `HTTP 401: Bad credentials` | Token is invalid or from wrong server |
| `Resource not accessible by personal access token` | Use Classic PAT instead of Fine-grained |
| `upload-artifact@v4 not supported on GHES` | Use `@v3` versions of artifact actions |

See [TROUBLESHOOTING.md](TROUBLESHOOTING.md) for more solutions.
